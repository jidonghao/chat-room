<template>
  <div class="container">
    <div class="topMenu">
      <h2 class="title">
        <svg t="1667113230314" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
             p-id="6862" width="64" height="64">
          <path d="M522.8 735.4h20.5M715.9 716.4h-29.6" fill="#FFFFFF" p-id="6863"></path>
          <path d="M830.8 716.2s-22 43.2 12.3 61.2c0 0-58.6 7.3-80-36l40-40.7 27.7 15.5z" fill="#FECD44"
                p-id="6864"></path>
          <path d="M763 741.4l30.3-30.8 37.5 5.6c-21.2 25.2-28.9 46.5-31.5 56.2-14-5-28-14.2-36.3-31z" fill="#D6AD39"
                p-id="6865"></path>
          <path
            d="M533.1 609.4c0 92.8 75.2 168 168 168 58 0 109.1-29.4 139.3-74.1 18.1-26.8 28.7-59.1 28.7-93.9 0-92.8-75.2-168-168-168s-168 75.2-168 168z"
            fill="#FECD44" p-id="6866"></path>
          <path d="M777.8 609.4m-24.7 0a24.7 24.7 0 1 0 49.4 0 24.7 24.7 0 1 0-49.4 0Z" fill="#FFFFFF"
                p-id="6867"></path>
          <path d="M701.1 609.4m-24.7 0a24.7 24.7 0 1 0 49.4 0 24.7 24.7 0 1 0-49.4 0Z" fill="#FFFFFF"
                p-id="6868"></path>
          <path d="M624.4 609.4m-24.7 0a24.7 24.7 0 1 0 49.4 0 24.7 24.7 0 1 0-49.4 0Z" fill="#FFFFFF"
                p-id="6869"></path>
          <path d="M702 710.8h-32.3M397 680.7h46.7" fill="#FFFFFF" p-id="6870"></path>
          <path d="M215.4 680.4s34.8 68.3-19.4 96.7c0 0 92.6 11.5 126.5-56.8L259.3 656l-43.9 24.4z" fill="#1F53CC"
                p-id="6871"></path>
          <path d="M322.5 720.3l-47.9-48.7-59.2 8.9c33.4 39.8 45.6 73.5 49.8 88.7 22.1-7.8 44.2-22.3 57.3-48.9z"
                fill="#18409E" p-id="6872"></path>
          <path
            d="M685.9 511.6c0 146.6-118.9 265.5-265.5 265.5-91.6 0-172.4-46.4-220.1-117.1-28.6-42.4-45.3-93.5-45.3-148.4 0-146.6 118.9-265.5 265.5-265.5S685.9 365 685.9 511.6z"
            fill="#1F53CC" p-id="6873"></path>
          <path d="M299.2 511.6m-39 0a39 39 0 1 0 78 0 39 39 0 1 0-78 0Z" fill="#FFFFFF" p-id="6874"></path>
          <path d="M420.4 511.6m-39 0a39 39 0 1 0 78 0 39 39 0 1 0-78 0Z" fill="#FFFFFF" p-id="6875"></path>
          <path d="M541.5 511.6m-39 0a39 39 0 1 0 78 0 39 39 0 1 0-78 0Z" fill="#FFFFFF" p-id="6876"></path>
        </svg>
        <svg t="1667113313050" class="icon1" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
             p-id="9882" width="64" height="64">
          <path
            d="M682.2912 934.912H665.6l-84.992 4.3008-27.8528 1.3312H528.384c-76.1856 1.4336-146.2272 1.4336-228.0448 0h-25.1904l-24.6784-0.6144-27.9552-2.4576-38.5024-2.2528h-8.9088a31.9488 31.9488 0 0 1-31.744-31.744v-6.144c0-8.192-0.512-16.384-0.7168-24.6784s0-17.5104 0-26.0096v-25.2928c-0.6144-79.4624-0.6144-159.6416 0-238.3872v-16.896-16.7936c0-29.7984 0.7168-59.6992 1.2288-90.4192v-37.7856h538.4192z"
            fill="#FAB414" p-id="9883"></path>
          <path
            d="M860.16 933.5808c-15.4624-0.8192-55.808 1.3312-62.0544 1.3312h-120.832v-17.7152q1.536-25.4976 2.3552-50.4832 0-12.4928 0.7168-24.8832c1.9456-79.7696-8.0896-159.9488 0-242.176q0-11.3664 0.6144-22.528c0.6144-37.4784-0.512-74.6496-2.8672-113.7664v-42.1888h194.56a208.1792 208.1792 0 0 1 12.1856 48.128c1.1264 7.9872 1.7408 16.0768 2.1504 24.1664-0.6144 15.5648-1.1264 31.6416-1.536 48.128v24.8832c0 30.1056-0.8192 61.44 0 92.16v23.6544c-0.9216 57.7536-2.4576 180.8384-3.072 231.1168A20.48 20.48 0 0 1 860.16 933.5808z"
            fill="#F15921" p-id="9884"></path>
          <path
            d="M423.1168 142.0288C385.1264 167.936 301.4656 235.52 294.6048 241.152c-59.8016 49.5616-113.152 113.5616-174.8992 167.8336l-13.824 13.6192c-4.608 4.608-43.52 39.8336-49.664 44.7488a14.1312 14.1312 0 0 0 9.3184 24.8832c34.4064 4.608 86.528 5.5296 94.4128 6.9632a1096.9088 1096.9088 0 0 0 150.7328 8.192h30.72c83.968-7.5776 168.0384-0.7168 252.928 0.9216h28.3648c9.216 0 18.3296-1.024 27.3408-1.6384 28.9792-3.8912 57.0368-6.656 84.6848-8.6016l27.5456-1.7408 22.4256-0.9216 22.7328-0.7168c56.7296-1.1264 99.328-1.1264 151.3472-2.4576a14.1312 14.1312 0 0 0 9.3184-24.8832l-32.6656-28.4672-22.9376-20.48a706.3552 706.3552 0 0 0-36.0448-36.1472q-9.1136-8.6016-18.432-16.7936l-20.48-19.2512-21.504-18.5344c-40.0384-28.9792-76.0832-59.392-111.0016-90.3168l-20.48-18.5344C630.8864 174.08 589.1072 112.64 519.5776 83.968a24.7808 24.7808 0 0 0-14.7456-1.4336c-6.656 1.4336-74.1376 54.272-81.7152 59.4944z"
            fill="#136CA8" p-id="9885"></path>
          <path
            d="M451.8912 711.8848A83.3536 83.3536 0 0 0 440.32 694.3744c-21.8112-25.088-55.1936-29.2864-88.576-12.4928a65.1264 65.1264 0 0 0-35.1232 42.5984 117.76 117.76 0 0 0-3.584 18.3296c-1.3312 68.9152-11.1616 128.8192-1.536 198.3488 54.1696 0.9216 103.5264 1.1264 153.6 0.7168v-10.24c-13.2096-69.4272 6.8608-149.6064-13.2096-219.7504z"
            fill="#F15921" p-id="9886"></path>
        </svg>
      </h2>
      <img class="myInfo" @click="goMyPage" :src="myIcon" alt="">
    </div>
    <div class="myRoomList">
      <div class="control">
        <div @click="createRoom(0)">创建</div>
        <div style="height: 60%;width:0;border-left:  1px solid gray;"/>
        <div @click="createRoom(1)">加入</div>
      </div>

      <div class="chatItem" v-for="(item) in chartList"
           :key="item.topic"
           @click="goRoom(item)"
      >
        <div>{{ item.roomName }}</div>
        <div>聊天室id：{{ item.roomId }}</div>
      </div>

      <div v-if="!chartList.length" class="noChatTips">
        还没有聊天室?<br>
        <a @click="createRoom(0)">创建</a>或<a @click="createRoom(1)">加入</a>一个吧！
      </div>
    </div>
    <!--    -->
    <div v-if="showAdd" class="createAndAdd" @click="showAdd=false">
      <div class="c-container" @click.stop="">
        <div class="c-title">{{ createFlag === 0 ? '创建聊天室' : '加入聊天室' }}</div>
        <input type="text" @click.stop="" v-model="addNameOrId"
               :placeholder=" `请输入${createFlag===0?'聊天室名称':'聊天室id'}`">
        <div style="color: #ef2c2c;height: 1.4rem;margin-top: 2rem;">{{ showInfo }}</div>
        <button @click.stop="c_submit(createFlag)" :disabled="loading">确认</button>
      </div>
    </div>
  </div>
</template>

<script>
import router from "../../router";
import room from "../../api/room";
import UseMqtt from "../../utils/useMqtt";
import Room from "./room";

let userInfo = JSON.parse(localStorage.getItem("userInfo"))
export default {
  name: "chatRoom",
  data() {
    return {
      chartList: [],
      createFlag: 0,
      showInfo: '',
      addNameOrId: '',
      showAdd: false,
      loading: false,
      myIcon:require('../../../images/icons/my.svg')
    }
  },
  mounted() {
    this.client()
    this.getRoomList()
  },
  methods: {
    // 去指定房间
    goRoom(e) {
      router.push({name: 'room', params: {roomInfo: e}})
    },
    getRoomList() {
      room.getRoomList({id: userInfo.id}).then(res => {
        if (res.code === 'success') {
          this.chartList = res.data.res
        }
      })
    },
    c_submit(flag) {
      if (!this.addNameOrId) {
        this.showInfo = flag === 0 ? "给聊天室起个名吧~" : "我找不到该房间呀~"
      } else if (this.addNameOrId.length > 12) {
        this.showInfo = flag === 0 ? "名称太channnnnng了！" : "我找不到该房间呀~"
      } else {
        this.loading = true
        room.create({id: userInfo.id, flag, name: this.addNameOrId}).then(res => {
          if (res.code === 'success') {
            this.getRoomList()
            router.push({name: 'room', params: {roomInfo: res.data}})
            this.showAdd = false
          } else if(res.code === 'noSuccess') {
            this.showInfo = "房间不存在"
          } else {
            this.showInfo = "系统开小差了，请稍后再试~"
          }
        }).finally(() => {
          this.loading = false
        })
      }
    },
    // 创建
    createRoom(flag) {
      this.showAdd = true
      this.createFlag = flag
      this.addNameOrId = this.showInfo = ""

    },
    goMyPage(){
      router.push({name: 'my'})
    },
    // exit() {
    //   localStorage.removeItem('isLogin')
    //   localStorage.removeItem('userName')
    //   router.push({name: 'login'})
    // }

      client() {
        UseMqtt.createConnection((topic, payload) => {
          let result = '';
          for (let i = 0; i < payload.byteLength; i++) {
            result += String.fromCharCode(payload[i]);
          }
          const res = JSON.parse(result);
          // console.log("收到信息", res)
          // Room.methods.onNewMessage(res)
        })
      },
  },
  created() {
    document.querySelector("html").style.fontSize = "62.5%"
  }
}
</script>

<style scoped lang="scss">
.control {
  width: 100vw;
  height: 3.6rem;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  background: #f3f3f3;

  //margin-bottom: 1rem;

  div {
    width: 50%;
  }
}

.icon {
  width: 3.6rem;
  margin-right: -0.4rem;
}

.icon1 {
  margin-left: -0.4rem;
  width: 2.4rem;
}

.container {
  width: 100vw;
  height: 100vh;
  background: white;
  position: relative;
  padding-top: 4.6rem;
  overflow: hidden;
  box-sizing: border-box;

  .createAndAdd {
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.2);

    .c-container {
      position: absolute;
      top: 36%;
      left: 50%;
      width: 80%;
      height: 30%;
      border-radius: 12px;
      background-image: linear-gradient(320deg, #d5ffe2 10%, #31e9ff 100%);
      transform: translate(-50%, -50%);
      box-sizing: border-box;
      padding: 2rem 4rem;
      display: flex;
      flex-direction: column;
      align-items: center;

      .c-title {
        font-size: 1.6rem;
        margin-bottom: 2rem;
      }

      button {
        width: 12rem;
        height: 3rem;
        margin-bottom: 1.2rem;
        border: 0;
        border-radius: 1rem;
        background: #ffffff;
        transition: all 0.2s;
        box-shadow: 3px 4px 4px 1px #00000014;
        //

        &:active {
          background: rgba(255, 255, 255, 0.5);
        }
      }

      input {
        position: relative;
        //width: 24rem;
        height: 2.6rem;
        margin: 0.5rem 0;
        border-radius: 1rem;
        border: 0;
        padding: 0.4rem 2rem;
        box-shadow: 3px 4px 4px 1px #00000014;
        transition: all 0.2s;

        &:active {
          outline: 1px solid rgba(0, 0, 0, 0.5);
        }
      }
    }
  }

  .myRoomList {
    height: 100%;
    overflow: hidden;
    overflow-y: scroll;
    width: 100%;
    background: #f3f3f3;

    .chatItem {
      width: 100%;
      height: 5.6rem;
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      padding-left: 1.2rem;
      box-sizing: border-box;

      div:nth-child(1) {
        font-size: 1.6rem;
      }

      div:nth-child(2) {
        font-size: 1.2rem;
        opacity: 0.8;
        margin-top: 0.2rem;
      }
    }

    .chatItem:last-child {
      border-bottom: 0;
    }

    .noChatTips {
      font-size: 2.4rem;
      margin-top: 12rem;

      a {
        color: #0E5CAD;
        text-decoration: underline;
      }
    }
  }
}

.topMenu {
  width: 100vw;
  height: 4.6rem;
  position: absolute;
  top: 0;
  left: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 5px #0000004f;
  background-image: linear-gradient(135deg, #a9fbc6 10%, #45e3e9 100%);
  background-size: 200% 200%;
  animation: registerView 2s ease infinite alternate;

  @keyframes registerView {
    0% {
      background-position: 0 0;
    }
    100% {
      background-position: 100% 100%;
    }
  }

  .title {
    margin: 0;
    font-size: 1.5rem;
  }

  .myInfo {
    position: absolute;
    right: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2.4rem;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 50%;
  }
}

</style>
